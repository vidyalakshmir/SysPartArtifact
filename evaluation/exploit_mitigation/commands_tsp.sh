echo "RESULTS OF TSP"
echo "****************"

#Get broken payloads with the system calls that caused it
./compute_payloads_broken.sh payload_syscalls/tempsp_syscallsPerPayloads.txt tsp_filtered_syscalls > broken_payloads/tsp/broken_payloads.txt 

#Gets the list of payloads and if it is broken or not per application
./count_payloads_broken.sh payload_syscalls/tempsp_syscallsPerPayloads.txt tsp_filtered_syscalls > broken_payloads/tsp/is_payload_broken.txt

#For each payload, gets the number of applications that it is broken against
grep 'YES' broken_payloads/tsp/is_payload_broken.txt | awk {'print $1'} | sort | uniq -c | sort -nr > broken_payloads/tsp/payload_broken_count.txt

#For each payload, gets the number of applications that it is not broken against
grep 'NO' broken_payloads/tsp/is_payload_broken.txt | awk {'print $1'} | sort | uniq -c | sort -nr > broken_payloads/tsp/payload_not_broken_count.txt

#To find payloads which are broken by all applications
grep -w '6' broken_payloads/tsp/payload_broken_count.txt > broken_payloads/tsp/payloads_broken_by.txt

#printf "\n#Payloads broken by all server applications : \t"

#grep -w '6' broken_payloads/tsp/payload_broken_count.txt | wc -l

#Payloads which are not broken by any application
grep -w '6' broken_payloads/tsp/payload_not_broken_count.txt > broken_payloads/tsp/payloads_not_broken_by_any_apps.txt 

#printf "\n#Payloads not broken by any server applications : \t"
#grep -w '6' broken_payloads/tsp/payload_not_broken_count.txt | wc -l

#To find payloads which are broken atleast once
grep 'YES' broken_payloads/tsp/is_payload_broken.txt | awk {'print $1'} | sort | uniq > broken_payloads/tsp/payloads_broken_atleast_once.txt

#printf "\n#Payloads broken atleast once : \t"
#grep 'YES' broken_payloads/tsp/is_payload_broken.txt | awk {'print $1'} | sort | uniq | wc -l

#To find number of payloads broken by an application (eg: lighttpd)
printf "\nPercent of payloads broken by (TSP_Without): \n"
bb=$(grep 'YES' broken_payloads/tsp/is_payload_broken.txt | grep -w 'bind' | wc -l)
printf "\nbind : \t %f" $(echo "scale=4; ($bb / 535.0)*100" | bc)
bb=$(grep 'YES' broken_payloads/tsp/is_payload_broken.txt | grep -w 'httpd' | wc -l)
printf "\nhttpd : \t %f" $(echo "scale=4; ($bb / 535.0)*100" | bc)
bb=$(grep 'YES' broken_payloads/tsp/is_payload_broken.txt | grep -w 'lighttpd' | wc -l)
printf "\nlighttpd : \t %f" $(echo "scale=4; ($bb / 535.0)*100" | bc)
bb=$(grep 'YES' broken_payloads/tsp/is_payload_broken.txt | grep -w 'memcached' | wc -l)
printf "\nmemcached : \t %f" $(echo "scale=4; ($bb / 535.0)*100" | bc)
bb=$(grep 'YES' broken_payloads/tsp/is_payload_broken.txt | grep -w 'nginx' | wc -l)
printf "\nnginx : \t %f" $(echo "scale=4; ($bb / 535.0)*100" | bc)
bb=$(grep 'YES' broken_payloads/tsp/is_payload_broken.txt | grep -w 'redis' | wc -l)
printf "\nredis : \t %f" $(echo "scale=4; ($bb / 535.0)*100" | bc)


#********************************************************
#NOTE : For all evaluation below, we consider only those payloads which are broken due to a system call which has #an equivalent system call. Such payloads are called 'payloads with equivalent system calls'
	
#Payloads with equivalent system calls
./compute_equivalent_payloads.sh broken_payloads/tsp/broken_payloads.txt tsp_filtered_syscalls | grep -w 'EQ' > equivalent_syscall_payloads/tsp/payloads_with_equivalents.txt

#Payloads with no equivalent system calls

./compute_equivalent_payloads.sh broken_payloads/tsp/broken_payloads.txt tsp_filtered_syscalls | grep -w 'NOEQ' > equivalent_syscall_payloads/tsp/payloads_with_no_equivalents.txt

#To find which among the payloads with equivalent system calls are broken or not

./is_equivalent_payload_broken.sh broken_payloads/tsp/broken_payloads.txt tsp_filtered_syscalls > equivalent_syscall_payloads/tsp/is_equivalent_payload_broken.txt

#To get the equivalent system calls of servers and if they are blocked or not
grep -w 'lighttpd' equivalent_syscall_payloads/tsp/is_equivalent_payload_broken.txt > equivalent_syscall_payloads/tsp/lighttpd.out

#No: of payloads with no equivalents
printf "\nPercent of payloads broken considering equivalents (TSP_With): \n"

cc=$(grep -w 'bind' equivalent_syscall_payloads/tsp/payloads_with_no_equivalents.txt | wc -l)
dd=$(grep -w 'YES' equivalent_syscall_payloads/tsp/is_equivalent_payload_broken.txt | grep -w 'bind' | wc -l)
printf "\nbind : \t %f" $(echo "scale=4; (($cc+$dd) / 535.0)*100" | bc)

cc=$(grep -w 'httpd' equivalent_syscall_payloads/tsp/payloads_with_no_equivalents.txt | wc -l)
dd=$(grep -w 'YES' equivalent_syscall_payloads/tsp/is_equivalent_payload_broken.txt | grep -w 'httpd' | wc -l)
printf "\nhttpd : \t %f" $(echo "scale=4; (($cc+$dd) / 535.0)*100" | bc)

cc=$(grep -w 'lighttpd' equivalent_syscall_payloads/tsp/payloads_with_no_equivalents.txt | wc -l)
dd=$(grep -w 'YES' equivalent_syscall_payloads/tsp/is_equivalent_payload_broken.txt | grep -w 'lighttpd' | wc -l)
printf "\nlighttpd : \t %f" $(echo "scale=4; (($cc+$dd) / 535.0)*100" | bc)

cc=$(grep -w 'memcached' equivalent_syscall_payloads/tsp/payloads_with_no_equivalents.txt | wc -l)
dd=$(grep -w 'YES' equivalent_syscall_payloads/tsp/is_equivalent_payload_broken.txt | grep -w 'memcached' | wc -l)
printf "\nmemcached : \t %f" $(echo "scale=4; (($cc+$dd) / 535.0)*100" | bc)

cc=$(grep -w 'nginx' equivalent_syscall_payloads/tsp/payloads_with_no_equivalents.txt | wc -l)
dd=$(grep -w 'YES' equivalent_syscall_payloads/tsp/is_equivalent_payload_broken.txt | grep -w 'nginx' | wc -l)
printf "\nnginx : \t %f" $(echo "scale=4; (($cc+$dd) / 535.0)*100" | bc)

cc=$(grep -w 'redis' equivalent_syscall_payloads/tsp/payloads_with_no_equivalents.txt | wc -l)
dd=$(grep -w 'YES' equivalent_syscall_payloads/tsp/is_equivalent_payload_broken.txt | grep -w 'redis' | wc -l)
printf "\nredis : \t %f" $(echo "scale=4; (($cc+$dd) / 535.0)*100" | bc)
